<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../app-theme.html">
<link rel="import" href="pup-alert-login.html">

<dom-module id="pup-alert-app">
  <template>
    <style include="app-theme">
      :host {
        display: block;
      }

      app-toolbar {
        background-color: var(--dark-primary-color);
        color: var(--primary-text-color);
      }

      .line {
        height: 30px;
      }
    </style>

    <firebase-app
      auth-domain="pup-alert-dev.firebaseapp.com"
      database-url="https://pup-alert-dev.firebaseio.com"
      api-key="AIzaSyDTB8FOhoqeHj-kvxfkTjSxOIuCBYA_uXU"
      storage-bucket="pup-alert-dev.appspot.com"
      messaging-sender-id="483016445952">
    </firebase-app>
    <firebase-auth id="auth" user="{{user}}" signed-in="{{signedIn}}" status-known="{{statusKnown}}" on-error="handleError"></firebase-auth>
    <firebase-messaging id="messaging" token="{{token}}"></firebase-messaging>
    <firebase-document path="/users/[[user.uid]]/token" data="[[token]]"></firebase-document>
    <firebase-document path="/temperature/Rn9yIaOY8taM04UeAd4IYcDZ75t2" data="{{temperature}}"></firebase-document>

    <app-header-layout>
      <app-header>
        <app-toolbar>
          <div main-title>Pup Alert Dev</div>
        </app-toolbar>
      </app-header>

      <pup-alert-login id="login"></pup-alert-login>
      <div id="app" class="content">
        <div class="line">
          <div class="label">Temperature</div>
          <div class="value">[[_toFixed(temperature, 1)]]C</div>
        </div>
        <paper-button on-tap="signOut" raised>Sign Out</paper-button>
      </div>
    </app-header-layout>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PupAlertApp extends Polymer.Element {
      static get is() { return 'pup-alert-app'; }
      static get properties() {
        return {
          signedIn: {
            type: Boolean
          },
          statusKnown: {
            type: Boolean
          },
          user: {
            type: Object
          },
          temperature: {
            type: Number
          }
        };
      }
      static get observers() {
        return [
          '_userChanged(statusKnown, signedIn, user)'
        ];
      }

      _userChanged(statusKnown, signedIn, user) {
        if (!statusKnown) {
          return;
        }

        Polymer.dom(this.$.login).classList.toggle('hidden', signedIn);
        Polymer.dom(this.$.app).classList.toggle('hidden', !signedIn);
        if (signedIn) {
          this.$.messaging.requestPermission().then(() => {
            // permission was granted
          }, (err) => {
            // permission was denied
            console.warn(err);
          });
        }
      }

      signOut() {
        this.$.auth.signOut();
      }

      _toFixed(value, digits) {
        return Number(value).toFixed(digits);
      }
    }

    window.customElements.define(PupAlertApp.is, PupAlertApp);
  </script>
</dom-module>
